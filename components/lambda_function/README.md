# Lambda Function

This module creates a Lambda function, which is our preferred tool for serverless tasks at DoSomething.org. It will also create a CloudWatch log group (which optionally forwards to Papertrail), IAM execution role, deployment S3 bucket (and default "hello world" application), and deployment credentials for CircleCI.

For all options, see the [variables](https://github.com/DoSomething/infrastructure/blob/master/components/lambda_function/variables.tf) this module accepts & [outputs](https://github.com/DoSomething/infrastructure/blob/master/components/lambda_function/outputs.tf) it generates.

> :wave: Check out the [Getting Started](https://github.com/DoSomething/infrastructure/blob/master/docs/serverless-guide.md) guide for a step-by-step walkthrough!

### Usage

We currently support Lambda functions running `nodejs8.10`, `python2.7`, and `python3.7`.

```hcl
module "app" {
  source = "../components/lambda_function"

  name    = "hello-serverless"
  runtime = "nodejs8.10"

  # Optional: Run the 'handler' function exported from 'main.js'.
  # This defaults to 'main.handler' if not explicitly set.
  handler = "main.handler"
}
```

You can send logs generated by this function to [Papertrail](https://github.com/DoSomething/communal-docs/blob/master/Monitoring/papertrail.md) by setting the `logger` variable (using one the `papertrail` modules from either `dosomething`, `dosomething-qa,` or `dosomething-dev`):

```hcl
module "app" {
  source = "../components/lambda_function"

  name   = "hello-serverless"
  logger = "${module.papertrail}"
}
```

You can attach additional permissions (such as allowing access to a DynamoDB table) using the `lambda_role` export:

```hcl
module "app" {
  source = "../components/lambda_function"
  name   = "hello-serverless"
}

resource "aws_iam_role_policy_attachment" "dynamodb_policy" {
  role       = "${module.app.lambda_role}"
  policy_arn = "${aws_iam_policy.dynamodb_policy.arn}"
}

resource "aws_iam_policy" "dynamodb_policy" {
  name = "${var.name}-dynamodb"
  path = "/"

  policy = "${file("${path.module}/policy.json")}"
}
```

### Deploying Code

Your Lambda will be set up with a default "hello world" function. You can deploy your own code using [CircleCI](https://circleci.com) and our [`dosomething/lambda`](https://github.com/DoSomething/lambda-orb) helper "orb". This will automatically load the deployment credentials generated by this module in the `/circleci/` SSM namespace.
